<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-MIND í†µí•© ì—­ëŸ‰ ì¸ì¦ ì‹œìŠ¤í…œ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [ì¤‘ìš”] ì„ ìƒë‹˜ì´ ì œê³µí•´ì£¼ì‹  ì˜¬ë°”ë¥¸ í‚¤ê°’ì„ ì—¬ê¸°ì— ì ìš©í–ˆìŠµë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "AIzaSyBbb1jaysjUlBjb4wFzoxQK789QQOT79GA",
            authDomain: "g-mind-78c4a.firebaseapp.com",
            projectId: "g-mind-78c4a",
            storageBucket: "g-mind-78c4a.firebasestorage.app",
            messagingSenderId: "708252783302",
            appId: "1:708252783302:web:14f5dcca23451d0f7dbdc7",
            measurementId: "G-RJ16KGZY9N"
        };

        // ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (í•™êµ ì•± ID)
        const appId = 'gmind-school-app'; 
        
        // ìœˆë„ìš° ì „ì—­ ê°ì²´ì— í• ë‹¹ (HTML ë²„íŠ¼ì—ì„œ í•¨ìˆ˜ë¥¼ ë¶€ë¥´ê¸° ìœ„í•´ í•„ìˆ˜)
        window.currentStudentId = null;
        window.classData = []; 
        window.teacherName = localStorage.getItem('gmind_teacher_name') || '';
        window.db = db;
        window.appId = appId;
        window.authReady = false;
        window.isEditMode = true;

        // 1. ì„œë²„ ì ‘ì† ì‹œë„ (ìµëª… ë¡œê·¸ì¸)
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth Error:", e);
                // ì—ëŸ¬ ë°œìƒ ì‹œ í™”ë©´ì— ë¹¨ê°„ ê¸€ì”¨ë¡œ í‘œì‹œ
                updateStatus("ì„œë²„ í‚¤ ì˜¤ë¥˜: ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.", "error");
            }
        }

        // 2. ì ‘ì† ìƒíƒœ ê°ì§€ (ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì‹¤í–‰ë¨)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase Connected:", user.uid);
                updateStatus("ğŸŸ¢ ì„œë²„ ì •ìƒ ì—°ê²°ë¨", "success");
                window.authReady = true;
                loadClassList();
            } else {
                updateStatus("ğŸ”´ ì„œë²„ ì—°ê²° ëŠê¹€", "error");
            }
        });

        // ì‹¤í–‰
        initAuth();

        // 3. ì£¼ìš” ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
        window.loadClassList = async function() {
            if (!window.authReady) return;
            const storedClass = localStorage.getItem('gmind_class_list_v4');
            if (storedClass) {
                window.classData = JSON.parse(storedClass);
            } else {
                // ì´ˆê¸° ë°ì´í„° ìƒ˜í”Œ
                window.classData = [
                    { id: '1101', name: 'ê¹€ì² ìˆ˜', dept: 'ì •ë°€ê¸°ê³„ê³¼', total: 0, grade: 'Ready' },
                    { id: '1102', name: 'ì´ì˜í¬', dept: 'ìë™í™”ì‹œìŠ¤í…œê³¼', total: 85, grade: 'S' }
                ];
                saveClassLocal();
            }
            // ì„ ìƒë‹˜ ì´ë¦„ì´ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ, ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
            if(window.teacherName) showDashboard(); else showLogin();
        };

        window.showLogin = function() { hideAllViews(); document.getElementById('view-login').style.display = 'flex'; }
        
        window.showDashboard = function() {
            if(!window.teacherName) {
                const nameInput = document.getElementById('login-name').value.trim();
                if(!nameInput) return alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                window.teacherName = nameInput;
                localStorage.setItem('gmind_teacher_name', window.teacherName);
            }
            document.getElementById('welcome-msg').innerText = `${window.teacherName} ì„ ìƒë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
            hideAllViews();
            document.getElementById('view-dashboard').style.display = 'block';
        }

        window.enterInputMode = function() {
            window.isEditMode = true;
            document.getElementById('list-title').innerText = "ğŸ“ í•™ìƒ í‰ê°€ ì…ë ¥ (ìˆ˜ì • ê°€ëŠ¥)";
            showClassInput();
        }
        window.enterLookupMode = function() {
            window.isEditMode = false;
            document.getElementById('list-title').innerText = "ğŸ” í•™ìƒ ìƒì„¸ ì¡°íšŒ (ì½ê¸° ì „ìš©)";
            showClassInput();
        }

        window.showClassInput = function() {
            hideAllViews();
            document.getElementById('view-class').style.display = 'block';
            renderClassGrid();
        }

        window.showStats = function() {
            hideAllViews();
            document.getElementById('view-stats').style.display = 'block';
            renderCharts();
        }

        window.showAdmin = function() {
            hideAllViews();
            document.getElementById('view-admin').style.display = 'block';
        }

        window.logout = function() {
            window.teacherName = '';
            localStorage.removeItem('gmind_teacher_name');
            showLogin();
        }

        function hideAllViews() {
            const views = ['view-login', 'view-dashboard', 'view-class', 'view-eval', 'view-lookup', 'view-stats', 'view-admin'];
            views.forEach(id => document.getElementById(id).style.display = 'none');
        }

        // í•™ìƒ ì„ íƒ ë° ë°ì´í„° ë¡œë“œ
        window.selectStudent = async function(id) {
            window.currentStudentId = id;
            const student = window.classData.find(s => s.id === id);
            
            let data = {};
            // íŒŒì´ì–´ë² ì´ìŠ¤ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            if (window.authReady) {
                try {
                    const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'gmind_records_v4', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) data = docSnap.data();
                } catch (e) { console.error("Data Load Error:", e); }
            }

            if (window.isEditMode) {
                hideAllViews();
                document.getElementById('view-eval').style.display = 'block';
                setupEvalView(student, data);
            } else {
                hideAllViews();
                document.getElementById('view-lookup').style.display = 'block';
                renderLookupView(student, data);
            }
        };

        function setupEvalView(student, data) {
            document.getElementById('target-info').innerText = `[${student.dept}] ${student.id} ${student.name}`;
            document.getElementById('inp-dept').value = student.dept;
            document.getElementById('inp-id').value = student.id;
            document.getElementById('inp-name').value = student.name;

            document.getElementById('sc-job').value = data.job || 0;
            document.getElementById('sc-char').value = data.char || 0;
            document.getElementById('sc-pro').value = data.pro || 0;
            document.getElementById('sc-lang').value = data.lang || 0;
            
            if(data.detailData) {
                const parsed = JSON.parse(data.detailData);
                window.jobDetails = parsed.job || { kor: 5, eng: 5, math: 5, prob: 5, certs: [] };
                window.charDetails = parsed.char || { mileage: 0, attend: 20, after: 0, readings: [] };
                window.currentScores = parsed.scores || { char: [], pro: [], lang: [] };
                window.fileData = parsed.files || { job: {}, char: {}, pro: {}, lang: {}, readings: {} };
            } else {
                window.jobDetails = { kor: 5, eng: 5, math: 5, prob: 5, certs: [] };
                window.charDetails = { mileage: 0, attend: 20, after: 0, readings: [] };
                window.currentScores = { char: [], pro: [], lang: [] };
                window.fileData = { job: {}, char: {}, pro: {}, lang: {}, readings: {} };
            }
            window.calc();
        }

        // í•™ìƒ ë°ì´í„° ì €ì¥
        window.saveStudent = async function() {
            if (!window.authReady) { alert("ì„œë²„ ë¯¸ì—°ê²° ìƒíƒœì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."); return; }
            const id = window.currentStudentId;
            const studentIdx = window.classData.findIndex(s => s.id === id);
            
            const total = document.getElementById('disp-total').innerText;
            const grade = document.getElementById('disp-grade').innerText;

            window.classData[studentIdx].total = Number(total);
            window.classData[studentIdx].grade = grade;
            saveClassLocal();

            const detailData = {
                job: window.jobDetails,
                char: window.charDetails,
                scores: window.currentScores,
                files: window.fileData
            };

            const data = {
                dept: document.getElementById('inp-dept').value,
                studentId: id, name: document.getElementById('inp-name').value,
                job: document.getElementById('sc-job').value,
                char: document.getElementById('sc-char').value,
                pro: document.getElementById('sc-pro').value,
                lang: document.getElementById('sc-lang').value,
                detailData: JSON.stringify(detailData),
                updatedAt: new Date().toISOString()
            };

            try {
                // íŒŒì´ì–´ë² ì´ìŠ¤ì— ì €ì¥
                await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'gmind_records_v4', id), data);
                alert(`âœ… ${window.classData[studentIdx].name} í•™ìƒ ë°ì´í„°ê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                showClassInput();
            } catch (e) { 
                console.error(e);
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message + "\n(ë°ì´í„°ë² ì´ìŠ¤ ê·œì¹™ì´ í—ˆìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)"); 
            }
        };

        function updateStatus(msg, type) {
            const els = document.querySelectorAll('.server-status');
            els.forEach(el => { el.innerText = msg; el.style.color = type === 'success' ? '#2ecc71' : '#e74c3c'; });
        }
    </script>

    <style>
        :root {
            --c-main: #34495e; --c-acc: #3498db; --bg-body: #f4f7f6;
            --c-job: #3498db; --c-char: #2ecc71; --c-pro: #e67e22; --c-lang: #9b59b6;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-body); margin: 0; padding: 0; color: #333; height: 100vh; overflow: hidden; word-break: keep-all; }
        
        .app-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .view-section { flex: 1; overflow-y: auto; display: none; padding: 20px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ë¡œê·¸ì¸ */
        #view-login { display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #2c3e50, #4ca1af); height: 100vh; color: white; text-align: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 400px; color: #333; }
        .login-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 1.1rem; margin-bottom: 20px; }
        .btn-login { width: 100%; padding: 15px; background: var(--c-acc); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-family: 'Jua'; cursor: pointer; }

        /* ëŒ€ì‹œë³´ë“œ */
        #view-dashboard { max-width: 1200px; margin: 0 auto; width: 100%; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .menu-card { background: white; padding: 30px; border-radius: 20px; cursor: pointer; transition: 0.3s; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--c-acc); box-shadow: 0 10px 25px rgba(52, 152, 219, 0.2); }
        .menu-icon { font-size: 3rem; margin-bottom: 15px; }
        .menu-title { font-family: 'Jua'; font-size: 1.5rem; margin-bottom: 10px; color: #2c3e50; }

        /* í•™ê¸‰ ì…ë ¥ & ì¡°íšŒ */
        .toolbar { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .student-card { background: white; border-radius: 15px; padding: 20px; border: 2px solid #eee; cursor: pointer; transition: 0.2s; position: relative; }
        .student-card:hover { border-color: var(--c-acc); transform: translateY(-3px); }
        .student-card.done { background: #f0fdf4; border-color: #2ecc71; }
        .grade-badge { position: absolute; top: 15px; right: 15px; background: #eee; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
        .student-card.done .grade-badge { background: #2ecc71; color: white; }

        /* í‰ê°€ ë° ì¡°íšŒ ê³µí†µ */
        .eval-header { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .score-box { background: white; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid #eee; transition: 0.2s; }
        .score-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .score-display { font-family: 'Jua'; font-size: 2.5rem; border: none; width: 100%; text-align: center; pointer-events: none; }

        /* ì¡°íšŒ(Lookup) ì „ìš© ìŠ¤íƒ€ì¼ */
        .lookup-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .lookup-title { font-family: 'Jua'; font-size: 1.8rem; border-bottom: 3px solid #eee; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .checklist-group { margin-bottom: 30px; }
        .group-header { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .group-badge { background: #eee; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; color: #666; }
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .check-item.checked { background: #f9fff9; }
        .check-icon { font-size: 1.2rem; margin-right: 10px; }
        .evidence-tag { background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }

        /* ê´€ë¦¬ì ëª¨ë“œ */
        .admin-box { background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; }
        .btn-admin { background: #34495e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Jua'; display: inline-flex; align-items: center; gap: 5px; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 95%; max-width: 800px; border-radius: 20px; padding: 30px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* ê³µí†µ ë²„íŠ¼ */
        .btn-primary { background: var(--c-acc); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Jua'; }
        .btn-secondary { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Jua'; }
        .btn-excel { display: inline-flex; align-items: center; gap: 5px; padding: 8px 15px; background: #27ae60; color: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        input[type="file"] { display: none; }

        /* ì¸ì‡„ */
        @media print {
            body * { visibility: hidden; }
            .certificate-view, .certificate-view * { visibility: visible; }
            .certificate-view { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0; }
            @page { size: landscape; margin: 0; }
        }
        .certificate-view { display: none; width: 297mm; height: 210mm; padding: 15mm; background: white; text-align: center; border: 5px double #b8860b; }
    </style>
</head>
<body>

<div class="app-wrapper">

    <div id="view-login" class="view-section" style="display:flex;">
        <div class="login-box">
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ’</div>
            <h1>G-MIND í†µí•© ê´€ë¦¬</h1>
            <p style="margin-bottom:30px; color:#666;">ì„ ìƒë‹˜ ì„±í•¨ì„ ì…ë ¥í•˜ì—¬<br>ì—…ë¬´ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            <input type="text" id="login-name" class="login-input" placeholder="ì˜ˆ: í™ê¸¸ë™">
            <button class="btn-login" onclick="showDashboard()">ì‹œìŠ¤í…œ ì…ì¥</button>
            <div class="server-status" style="margin-top:20px;">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="dash-header">
            <div>
                <span class="dash-welcome" id="welcome-msg">ì„ ìƒë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</span>
                <div class="server-status" style="display:inline-block; margin-left:10px;"></div>
            </div>
            <button class="btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="card-grid">
            <div class="menu-card" onclick="enterInputMode()">
                <div class="menu-icon">ğŸ“</div>
                <div class="menu-title">í•™ìƒ í‰ê°€ ì…ë ¥</div>
                <div class="menu-desc">í•™ìƒë“¤ì˜ ì—­ëŸ‰ì„ í‰ê°€í•˜ê³ <br>ì ìˆ˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="menu-card" onclick="enterLookupMode()">
                <div class="menu-icon">ğŸ”</div>
                <div class="menu-title">í•™ìƒ ìƒì„¸ ì¡°íšŒ</div>
                <div class="menu-desc">í‰ê°€ ê²°ê³¼ë¥¼ ìƒì„¸ ì²´í¬ë¦¬ìŠ¤íŠ¸<br>í˜•íƒœë¡œ í™•ì¸í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="menu-card" onclick="showStats()">
                <div class="menu-icon">ğŸ“Š</div>
                <div class="menu-title">í†µê³„ í˜„í™©</div>
                <div class="menu-desc">í•™ê¸‰ ì „ì²´ì˜ ë“±ê¸‰ ë¶„í¬ì™€<br>ì§„í–‰ë¥ ì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="menu-card" onclick="showAdmin()">
                <div class="menu-icon">âš™ï¸</div>
                <div class="menu-title">ê´€ë¦¬ì ëª¨ë“œ</div>
                <div class="menu-desc">í•™ê¸‰ ëª…ë ¬í‘œ ì¼ê´„ ë“±ë¡<br>ë° ë°ì´í„° ì´ˆê¸°í™”</div>
            </div>
        </div>
    </div>

    <div id="view-class" class="view-section">
        <div class="toolbar">
            <h2 id="list-title" style="margin:0; font-family:'Jua';">ğŸ“ í•™ê¸‰ í‰ê°€ ê´€ë¦¬</h2>
            <button class="btn-secondary" onclick="showDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
        </div>
        
        <div class="toolbar" style="background:#f8f9fa;">
            <div style="display:flex; gap:10px; align-items:center;">
                <span style="font-weight:bold; color:#555;">ê°œë³„ì ìˆ˜ ë°˜ì˜:</span>
                <label class="btn-excel">ğŸ“‚ ë‚˜ì´ìŠ¤ ì¶œê²° <input type="file" accept=".xlsx" onchange="handleExcel(this, 'attendance')"></label>
                <label class="btn-excel" style="background:#e67e22;">ğŸ“‚ ë°©ê³¼í›„ <input type="file" accept=".xlsx" onchange="handleExcel(this, 'afterschool')"></label>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="new-name" placeholder="ì´ë¦„" style="padding:8px; width:80px; border:1px solid #ddd; border-radius:5px;">
                <input type="text" id="new-id" placeholder="í•™ë²ˆ" style="padding:8px; width:80px; border:1px solid #ddd; border-radius:5px;">
                <button class="btn-primary" onclick="addStudent()">ì¶”ê°€</button>
            </div>
        </div>
        <div class="student-grid" id="student-grid"></div>
    </div>

    <div id="view-eval" class="view-section">
        <div class="eval-header">
            <div>
                <button class="btn-secondary" onclick="showClassInput()">â—€ ëª©ë¡</button>
                <span id="target-info" style="margin-left:15px; font-weight:bold; font-size:1.2rem;"></span>
            </div>
            <button class="btn-primary" onclick="saveStudent()">ğŸ’¾ ì €ì¥ ì™„ë£Œ</button>
        </div>
        <input type="hidden" id="inp-dept"><input type="hidden" id="inp-id"><input type="hidden" id="inp-name">

        <div class="score-grid">
            <div class="score-box type-job" onclick="openRubric('job')">
                <h3>ì§ì—…ê¸°ì´ˆ</h3>
                <input type="text" id="sc-job" class="score-display" value="0" readonly>
            </div>
            <div class="score-box type-char" onclick="openRubric('char')">
                <h3>ì¸ì„±ëŠ¥ë ¥</h3>
                <input type="text" id="sc-char" class="score-display" value="0" readonly>
            </div>
            <div class="score-box type-pro" onclick="openRubric('pro')">
                <h3>ì „ê³µì—­ëŸ‰</h3>
                <input type="text" id="sc-pro" class="score-display" value="0" readonly>
            </div>
            <div class="score-box type-lang" onclick="openRubric('lang')">
                <h3>ì™¸êµ­ì–´</h3>
                <input type="text" id="sc-lang" class="score-display" value="0" readonly>
            </div>
        </div>
        <div style="text-align:center; padding:20px;">
            <span style="font-size:1.5rem;">ì´ì : <strong id="disp-total" style="color:#f1c40f;">0</strong> / ë“±ê¸‰: <strong id="disp-grade" style="color:#34495e;">Ready</strong></span>
        </div>
    </div>

    <div id="view-lookup" class="view-section">
        <div class="lookup-container">
            <div class="lookup-title">
                <div>
                    <span id="lookup-name" style="color:#2c3e50;">í™ê¸¸ë™</span> 
                    <span id="lookup-info" style="font-size:1rem; color:#7f8c8d; margin-left:10px;">(1101)</span>
                </div>
                <button class="btn-secondary" onclick="showClassInput()">â—€ ëª©ë¡ìœ¼ë¡œ</button>
            </div>

            <div style="margin-bottom:30px; text-align:center; background:#f8f9fa; padding:20px; border-radius:15px;">
                <span style="font-size:2rem; font-weight:bold; color:#2c3e50;">ì¢…í•© ë“±ê¸‰: <span id="lookup-grade" style="color:#f1c40f;">G</span></span>
                <span style="font-size:1.2rem; margin-left:15px; color:#555;">(ì´ì : <span id="lookup-total">0</span>ì )</span>
            </div>

            <div id="lookup-content">
                </div>
        </div>
    </div>

    <div id="view-stats" class="view-section">
        <div class="toolbar">
            <h2 style="margin:0; font-family:'Jua';">ğŸ“Š ìš°ë¦¬ ë°˜ í†µê³„</h2>
            <button class="btn-secondary" onclick="showDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
        </div>
        <div class="chart-container" style="background:white; padding:30px; border-radius:20px;">
            <div style="display:flex; gap:20px; height:400px;">
                <div style="flex:1;"><canvas id="chart-grade"></canvas></div>
                <div style="flex:1;"><canvas id="chart-progress"></canvas></div>
            </div>
        </div>
    </div>

    <div id="view-admin" class="view-section">
        <div class="toolbar">
            <h2 style="margin:0; font-family:'Jua';">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
            <button class="btn-secondary" onclick="showDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
        </div>

        <div class="admin-box">
            <h3 style="margin-top:0;">ğŸ“‚ í•™ê¸‰ ëª…ë ¬í‘œ ì¼ê´„ ë“±ë¡</h3>
            <p style="color:#666; font-size:0.9rem;">ì—‘ì…€ íŒŒì¼ì— [í•™ë…„, ë°˜, ë²ˆí˜¸, ì´ë¦„, í•™ê³¼] ì—´ì´ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br>(ì˜ˆ: 1í•™ë…„ 3ë°˜ 5ë²ˆ -> í•™ë²ˆ 1305 ìë™ìƒì„±)</p>
            <label class="btn-admin">
                ğŸ“‘ ëª…ë ¬í‘œ ì—‘ì…€ ì—…ë¡œë“œ
                <input type="file" accept=".xlsx, .xls" onchange="handleRosterExcel(this)">
            </label>
        </div>

        <div class="admin-box">
            <h3 style="margin-top:0;">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</h3>
            <p style="color:#e74c3c; font-weight:bold;">â€» ëª¨ë“  í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.</p>
            <button class="btn-secondary" style="background:#e74c3c;" onclick="clearAllData()">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
    </div>

</div>

<div id="rubric-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modal-title" style="margin:0 0 15px 0; font-family:Jua; border-bottom:2px solid #eee; padding-bottom:10px;">ì„¸ë¶€ í‰ê°€</h2>
        <div id="modal-content"></div>
        <div style="margin-top:20px; text-align:right;">
             <span style="font-size:1.2rem; margin-right:20px;">í•©ê³„: <strong id="modal-score" style="color:#e74c3c;">0</strong>ì </span>
            <button class="btn-primary" onclick="closeRubric()">ë°˜ì˜í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // [ë°ì´í„° ì´ˆê¸°í™”]
    window.jobDetails = { kor: 5, eng: 5, math: 5, prob: 5, certs: [] };
    window.charDetails = { mileage: 0, attend: 20, after: 0, readings: [] };
    window.currentScores = { char: [], pro: [], lang: [] };
    window.fileData = { job: {}, char: {}, pro: {}, lang: {}, readings: {} };

    let currentArea = '';

    const RUBRIC_COMMON = {
        'pro': { title: "ì „ê³µì—­ëŸ‰ (30ì )", max: 30, items: [
            { score: 8, label: "ì „ê³µ ìê²©ì¦ ì¼ë°˜" }, { score: 7, label: "ì˜ë¬´ê²€ì •/ë©´ì œ ì·¨ë“" },
            { score: 5, label: "í”„ë¡œì íŠ¸ ìˆ˜ì—… ì°¸ì—¬" }, { score: 5, label: "ê¸°ì—…ì²´ í”„ë¡œê·¸ë¨ ì°¸ì—¬" },
            { score: 10, label: "ì „êµ­ ê¸°ëŠ¥ëŒ€íšŒ ì…ìƒ" }, { score: 5, label: "ì§€ë°© ê¸°ëŠ¥ëŒ€íšŒ ì…ìƒ" }
        ]},
        'lang': { title: "ì™¸êµ­ì–´ëŠ¥ë ¥ (5ì )", max: 5, items: [
            { score: 5, label: "ì˜ì–´ ìš°ìˆ˜ (í† ìµ 600/ì˜¤í”½ IM2)" }, { score: 3, label: "ì˜ì–´ ë³´í†µ (í† ìµ 300~595)" },
            { score: 5, label: "ì¼/ì¤‘ ìš°ìˆ˜ (JPT 600/N2)" }, { score: 3, label: "ì¼/ì¤‘ ë³´í†µ (JPT 525/N3)" }
        ]}
    };
    const JOB_CERTS = [
        { id: 0, label: "ì»´í™œ/ì›Œë“œ 2ê°œ", score: 5 }, { id: 1, label: "ì»´í™œ/ì›Œë“œ 1ê°œ", score: 3 },
        { id: 2, label: "í•œêµ­ì‚¬ 1ê¸‰", score: 6 }, { id: 3, label: "í•œêµ­ì‚¬ 2ê¸‰", score: 4 }
    ];

    window.renderClassGrid = function() {
        const grid = document.getElementById('student-grid');
        grid.innerHTML = "";
        window.classData.forEach(s => {
            const div = document.createElement('div');
            div.className = `student-card ${s.grade !== 'Ready' ? 'done' : ''}`;
            div.onclick = () => selectStudent(s.id);
            div.innerHTML = `
                <div class="grade-badge">${s.grade}</div>
                <h3 style="margin:0 0 5px 0;">${s.name}</h3>
                <div style="color:#777; font-size:0.9rem;">${s.id}</div>
                <div style="color:${s.total > 0 ? '#3498db' : '#ccc'}; font-weight:bold; margin-top:10px;">${s.total}ì </div>
            `;
            grid.appendChild(div);
        });
    };
    window.saveClassLocal = function() { localStorage.setItem('gmind_class_list_v4', JSON.stringify(window.classData)); };
    
    // [ê´€ë¦¬ì: ëª…ë ¬í‘œ ì—‘ì…€ ì—…ë¡œë“œ]
    window.handleRosterExcel = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            let count = 0;
            // ì˜ˆìƒ ì»¬ëŸ¼: í•™ë…„, ë°˜, ë²ˆí˜¸, ì´ë¦„, í•™ê³¼
            json.forEach(row => {
                let grade = row['í•™ë…„'];
                let cls = row['ë°˜'];
                let num = row['ë²ˆí˜¸'];
                let name = row['ì´ë¦„'] || row['ì„±ëª…'];
                let dept = row['í•™ê³¼'] || 'ê³µí†µ';

                if(grade && cls && num && name) {
                    // í•™ë²ˆ ìƒì„± (ì˜ˆ: 1í•™ë…„ 3ë°˜ 5ë²ˆ -> 1305)
                    let sid = `${grade}${cls}${String(num).padStart(2, '0')}`;
                    // ì¤‘ë³µ ì²´í¬ í›„ ì¶”ê°€
                    if(!window.classData.find(s => s.id === sid)) {
                        window.classData.push({ id: sid, name: name, dept: dept, total: 0, grade: 'Ready' });
                        count++;
                    }
                }
            });
            saveClassLocal();
            alert(`${count}ëª…ì˜ í•™ìƒì´ ëª…ë ¬í‘œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        reader.readAsArrayBuffer(file);
    };

    // [ì¡°íšŒ: ìƒì„¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§]
    window.renderLookupView = function(student, data) {
        document.getElementById('lookup-name').innerText = student.name;
        document.getElementById('lookup-info').innerText = `(${student.id} / ${student.dept})`;
        document.getElementById('lookup-total').innerText = student.total;
        document.getElementById('lookup-grade').innerText = student.grade;
        
        // ìƒì„¸ ë°ì´í„° íŒŒì‹±
        let jD = { kor: 5, eng: 5, math: 5, prob: 5, certs: [] };
        let cD = { mileage: 0, attend: 20, after: 0, readings: [] };
        let sc = { char: [], pro: [], lang: [] };
        let fl = { job: {}, char: {}, pro: {}, lang: {}, readings: {} };

        if(data.detailData) {
            const parsed = JSON.parse(data.detailData);
            if(parsed.job) jD = parsed.job;
            if(parsed.char) cD = parsed.char;
            if(parsed.scores) sc = parsed.scores;
            if(parsed.files) fl = parsed.files;
        }

        const container = document.getElementById('lookup-content');
        container.innerHTML = "";

        // 1. ì§ì—…ê¸°ì´ˆëŠ¥ë ¥
        let jobHtml = `<div class="checklist-group"><div class="group-header">ğŸ“˜ ì§ì—…ê¸°ì´ˆëŠ¥ë ¥ <span class="group-badge">${data.job||0}ì </span></div>`;
        // ê³¼ëª©
        jobHtml += `
            <div class="check-item ${jD.kor<=2 || jD.eng<=2 || jD.math<=2 || jD.prob<=2 ? 'checked' : ''}">
                <div><span class="check-icon">${jD.kor<=2 || jD.eng<=2 ? 'âœ…' : 'â¬œ'}</span> NCS ê³¼ëª© ë“±ê¸‰ (êµ­ì–´:${jD.kor}, ì˜ì–´:${jD.eng}, ìˆ˜í•™:${jD.math}, í•´ê²°:${jD.prob})</div>
                <div class="evidence-tag">ìµœê³ ë“±ê¸‰ ë°˜ì˜</div>
            </div>`;
        // ìê²©ì¦
        JOB_CERTS.forEach((c, idx) => {
            const isDone = jD.certs.includes(idx);
            jobHtml += `
                <div class="check-item ${isDone ? 'checked' : ''}">
                    <div><span class="check-icon">${isDone ? 'âœ…' : 'â¬œ'}</span> ${c.label}</div>
                    ${isDone && fl.job[idx] ? `<div class="evidence-tag">ğŸ“ ${fl.job[idx]}</div>` : ''}
                </div>`;
        });
        jobHtml += `</div>`;

        // 2. ì¸ì„±ëŠ¥ë ¥
        let charHtml = `<div class="checklist-group"><div class="group-header">ğŸŒ¿ ì¸ì„±ëŠ¥ë ¥ <span class="group-badge">${data.char||0}ì </span></div>`;
        charHtml += `
            <div class="check-item checked">
                <div><span class="check-icon">âœ…</span> ê·¸ë¦°ë§ˆì¼ë¦¬ì§€ / ì¶œê²° / ë°©ê³¼í›„</div>
                <div class="evidence-tag">ë§ˆì¼ë¦¬ì§€:${cD.mileage} / ì¶œê²°:${cD.attend} / ë°©ê³¼í›„:${cD.after}</div>
            </div>`;
        for(let i=0; i<5; i++) {
            const isDone = cD.readings.includes(i);
            charHtml += `
                <div class="check-item ${isDone ? 'checked' : ''}">
                    <div><span class="check-icon">${isDone ? 'âœ…' : 'â¬œ'}</span> ë…ì„œê°ìƒë¬¸ ${i+1}</div>
                    ${isDone && fl.readings[i] ? `<div class="evidence-tag">ğŸ“ ${fl.readings[i]}</div>` : ''}
                </div>`;
        }
        charHtml += `</div>`;

        // 3. ì „ê³µ & ì™¸êµ­ì–´
        let proHtml = generateLookupSection('ğŸ› ï¸ ì „ê³µì—­ëŸ‰', data.pro, 'pro', RUBRIC_COMMON['pro'].items, sc.pro, fl.pro);
        let langHtml = generateLookupSection('ğŸŒ ì™¸êµ­ì–´', data.lang, 'lang', RUBRIC_COMMON['lang'].items, sc.lang, fl.lang);

        container.innerHTML = jobHtml + charHtml + proHtml + langHtml;
    };

    function generateLookupSection(title, score, key, items, doneIndices, fileMap) {
        let html = `<div class="checklist-group"><div class="group-header">${title} <span class="group-badge">${score||0}ì </span></div>`;
        items.forEach((item, idx) => {
            const isDone = doneIndices.includes(idx);
            html += `
                <div class="check-item ${isDone ? 'checked' : ''}">
                    <div><span class="check-icon">${isDone ? 'âœ…' : 'â¬œ'}</span> ${item.label}</div>
                    ${isDone && fileMap[idx] ? `<div class="evidence-tag">ğŸ“ ${fileMap[idx]}</div>` : ''}
                </div>`;
        });
        html += `</div>`;
        return html;
    }

    // [ëª¨ë‹¬/íŒŒì¼ í•¸ë“¤ëŸ¬ ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€]
    window.openRubric = function(area) {
        currentArea = area;
        const content = document.getElementById('modal-content');
        if (area === 'job') {
            let h = `<table class="chk-table"><tr><th>ê³¼ëª© ë“±ê¸‰</th></tr><tr><td>
                êµ­ì–´ <select id="i-k" onchange="uJob()">${opts(window.jobDetails.kor)}</select>
                ì˜ì–´ <select id="i-e" onchange="uJob()">${opts(window.jobDetails.eng)}</select>
                ìˆ˜í•™ <select id="i-m" onchange="uJob()">${opts(window.jobDetails.math)}</select>
                í•´ê²° <select id="i-p" onchange="uJob()">${opts(window.jobDetails.prob)}</select>
                </td></tr></table><table class="chk-table"><tr><th>ìê²©ì¦ (íŒŒì¼ì²¨ë¶€)</th></tr>`;
            JOB_CERTS.forEach((c, i) => {
                const chk = window.jobDetails.certs.includes(i) ? 'checked' : '';
                h += `<tr><td><label><input type="checkbox" id="jc-${i}" ${chk} onchange="uJob()"> ${c.label}</label>
                      <br><label class="file-label">ğŸ“ íŒŒì¼<input type="file" onchange="hFile(this,'job',${i})"></label> <span class="file-name" id="fn-job-${i}">${window.fileData.job[i]||''}</span></td></tr>`;
            });
            content.innerHTML = h + `</table>`; uJob();
        } else if (area === 'char') {
            let h = `<div style="padding:10px; background:#f0f9ff; border-radius:10px; margin-bottom:10px;">
                <div style="margin-bottom:10px;">ğŸŒ± ê·¸ë¦°ë§ˆì¼ë¦¬ì§€: <input type="number" id="i-mil" value="${window.charDetails.mileage}" min="-10" max="10" onchange="uChar()" style="width:60px;">ì </div>
                <div style="margin-bottom:10px;">ğŸ“… ì¶œê²° (ì—‘ì…€/ì…ë ¥): <input type="number" id="i-att" value="${window.charDetails.attend}" min="0" max="20" onchange="uChar()" style="width:60px;">ì </div>
                <div>ğŸ« ë°©ê³¼í›„ (ì—‘ì…€/ì…ë ¥): <input type="number" id="i-aft" value="${window.charDetails.after}" min="0" max="6" onchange="uChar()" style="width:60px;">ì </div></div>
                <table class="chk-table"><tr><th>ë…ì„œê°ìƒë¬¸</th></tr>`;
            for(let i=0; i<5; i++) {
                const chk = window.charDetails.readings.includes(i) ? 'checked' : '';
                h += `<tr><td><label><input type="checkbox" id="rc-${i}" ${chk} onchange="uChar()"> ê°ìƒë¬¸ ${i+1}</label>
                      <br><label class="file-label">ğŸ“ íŒŒì¼<input type="file" onchange="hFile(this,'readings',${i})"></label> <span class="file-name" id="fn-readings-${i}">${window.fileData.readings[i]||''}</span></td></tr>`;
            }
            content.innerHTML = h + `</table>`; uChar();
        } else {
            let h = `<table class="chk-table"><tr><th>í•­ëª©</th></tr>`;
            RUBRIC_COMMON[area].items.forEach((item, i) => {
                const chk = window.currentScores[area].includes(i) ? 'checked' : '';
                h += `<tr><td><label><input type="checkbox" id="chk-${i}" ${chk} onchange="uComm()"> ${item.label}</label>
                      <br><label class="file-label">ğŸ“ ì¦ë¹™<input type="file" onchange="hFile(this,'${area}',${i})"></label> <span class="file-name" id="fn-${area}-${i}">${window.fileData[area][i]||''}</span></td></tr>`;
            });
            content.innerHTML = h + `</table>`; uComm();
        }
        document.getElementById('rubric-modal').style.display = 'flex';
    };

    function opts(v) { let s=''; for(let i=1;i<=5;i++) s+=`<option value="${i}" ${i==v?'selected':''}>${i}ë“±ê¸‰</option>`; return s; }
    
    // [ì ìˆ˜ ê³„ì‚° ë° íŒŒì¼ ì²˜ë¦¬]
    window.uJob = function() {
        const k=Number(document.getElementById('i-k').value), e=Number(document.getElementById('i-e').value);
        const m=Number(document.getElementById('i-m').value), p=Number(document.getElementById('i-p').value);
        const pts = [0, 7, 6, 5, 3, 2];
        const maxS = Math.max(pts[k], pts[e], pts[m], pts[p]);
        let cS = 0;
        JOB_CERTS.forEach((c,i) => { if(document.getElementById(`jc-${i}`).checked) cS += c.score; });
        document.getElementById('modal-score').innerText = Math.min(30, maxS + cS);
    };
    window.uChar = function() {
        const m=Number(document.getElementById('i-mil').value), a=Number(document.getElementById('i-att').value), f=Number(document.getElementById('i-aft').value);
        let r=0; for(let i=0;i<5;i++) if(document.getElementById(`rc-${i}`).checked) r++;
        document.getElementById('modal-score').innerText = m+a+f+r; 
    };
    window.uComm = function() {
        let t=0; RUBRIC_COMMON[currentArea].items.forEach((it,i) => { if(document.getElementById(`chk-${i}`).checked) t+=it.score; });
        document.getElementById('modal-score').innerText = Math.min(RUBRIC_COMMON[currentArea].max, t);
    };
    window.hFile = function(inp, cat, idx) {
        if(inp.files[0]) {
            const n = inp.files[0].name;
            if(cat==='readings') window.fileData.readings[idx]=n; else window.fileData[cat][idx]=n;
            document.getElementById(`fn-${cat==='readings'?'readings':cat}-${idx}`).innerText = n;
            const chkId = cat==='readings'?`rc-${idx}`:(cat==='job'?`jc-${idx}`:`chk-${idx}`);
            if(document.getElementById(chkId)) document.getElementById(chkId).checked = true;
            if(cat==='job') uJob(); else if(cat==='readings') uChar(); else uComm();
        }
    }
    window.closeRubric = function() {
        const s = Number(document.getElementById('modal-score').innerText);
        if(currentArea==='job') {
            window.jobDetails.kor=document.getElementById('i-k').value; window.jobDetails.eng=document.getElementById('i-e').value;
            window.jobDetails.math=document.getElementById('i-m').value; window.jobDetails.prob=document.getElementById('i-p').value;
            window.jobDetails.certs=[]; JOB_CERTS.forEach((c,i)=>{ if(document.getElementById(`jc-${i}`).checked) window.jobDetails.certs.push(i); });
            document.getElementById('sc-job').value = s;
        } else if(currentArea==='char') {
            window.charDetails.mileage=Number(document.getElementById('i-mil').value);
            window.charDetails.attend=Number(document.getElementById('i-att').value);
            window.charDetails.after=Number(document.getElementById('i-aft').value);
            window.charDetails.readings=[]; for(let i=0;i<5;i++) if(document.getElementById(`rc-${i}`).checked) window.charDetails.readings.push(i);
            document.getElementById('sc-char').value = s > 35 ? 35 : s;
        } else {
            window.currentScores[currentArea]=[];
            RUBRIC_COMMON[currentArea].items.forEach((it,i)=>{ if(document.getElementById(`chk-${i}`).checked) window.currentScores[currentArea].push(i); });
            document.getElementById(`sc-${currentArea}`).value = s;
        }
        window.calc();
        document.getElementById('rubric-modal').style.display='none';
    };
    window.calc = function() {
        const j=Number(document.getElementById('sc-job').value), c=Number(document.getElementById('sc-char').value);
        const p=Number(document.getElementById('sc-pro').value), l=Number(document.getElementById('sc-lang').value);
        const t = j+c+p+l;
        document.getElementById('disp-total').innerText = t;
        let g="Ready"; if(t>=90)g="G"; else if(t>=80)g="S"; else if(t>=70)g="A"; else if(t>0)g="B";
        document.getElementById('disp-grade').innerText = g;
    };
    window.clearAllData = function() {
        if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.clear();
            alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    }
</script>
</body>
</html>